'use client';

import { useEffect, useState } from 'react';
import type { Product } from '@/lib/mock-data';
import { Input } from '@/components/ui/input';
import { ExcelUploader } from '@/components/excel-uploader';
import {
  Card,
  CardHeader,
  CardTitle,
  CardDescription,
  CardContent,
} from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Search, Loader2 } from 'lucide-react';
import { searchMeson, ProductoPOSDPOFE } from '@/lib/api';

interface ProductoPOSDPOFE {
  sku: string;
  descripcionPromo: string;
  precioNormal: number;
  precioOferta?: number;
  precioUnitario?: number;
  vigenciaInicio?: string | null;
  vigenciaFin?: string | null;
  descuentoPct?: number;
}

interface ProductSearchProps {
  onProductSelect: (product: Product) => void;
  selectedProduct?: Product;
}

const BACKEND_URL =
  process.env.NEXT_PUBLIC_BACKEND_URL || 'http://localhost:3000';



useEffect(() => {
  const term = query.trim();
  if (!term) {
    setItems([]);
    setError(null);
    return;
  }
  const timeout = setTimeout(async () => {
    try {
      setLoading(true);
      setError(null);
      const data = await searchMeson(term);     // üëà usa la API con buildHeaders()
      setItems(data ?? []);
    } catch (err: any) {
      console.error('[ProductSearch] Error buscando en POSDPOFE:', err);
      setError(err?.message || 'Error buscando ofertas en POSDPOFE');
      setItems([]);
    } finally {
      setLoading(false);
    }
  }, 300);
  return () => clearTimeout(timeout);
}, [query]);

function mapOfertaToProduct(oferta: ProductoPOSDPOFE): Product {
  const tieneOferta = typeof oferta.precioOferta === 'number' && !Number.isNaN(oferta.precioOferta);

  return {
    id: oferta.sku,
    codigo: oferta.sku,
    codigoBarras: '',
    nombre: oferta.descripcionPromo,
    descripcion: oferta.descripcionPromo,
    dosage: '',
    batch: '',
    expiryDate: oferta.vigenciaFin ?? '',
    manufacturer: '',
    precioNormal: oferta.precioNormal ?? 0,
    precio: tieneOferta ? (oferta.precioOferta as number) : (oferta.precioNormal ?? 0),
    stock: 0,
    categoria: '',
    laboratorio: '',
    // ‚úÖ si no hay oferta, no definimos la propiedad (queda `undefined`, no `null`).
    ...(tieneOferta && {
      oferta: {
        precioOferta: oferta.precioOferta as number,
        descuentoPorcentaje: oferta.descuentoPct ?? 0,
        vigenciaFin: oferta.vigenciaFin ?? '',
        vigenciaInicio: oferta.vigenciaInicio ?? '',
        tipoOferta: '1',
      },
    }),
  };
}

export function ProductSearch({
  onProductSelect,
  selectedProduct,
}: ProductSearchProps) {
  const [query, setQuery] = useState('');
  const [loading, setLoading] = useState(false);
  const [items, setItems] = useState<ProductoPOSDPOFE[]>([]);
  const [error, setError] = useState<string | null>(null);

  // Buscar en POSDPOFE cada vez que cambia el query (con debounce)
  useEffect(() => {
    const term = query.trim();

    if (!term) {
      setItems([]);
      setError(null);
      return;
    }

    const timeout = setTimeout(async () => {
      try {
        setLoading(true);
        setError(null);

        const url = `${BACKEND_URL}/api/meson/search?term=${encodeURIComponent(
          term,
        )}`;

        const res = await fetch(url);
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}`);
        }

        const data = await res.json();
        setItems(data.productos ?? []);
      } catch (err) {
        console.error('[ProductSearch] Error buscando en POSDPOFE:', err);
        setError('Error buscando ofertas en POSDPOFE');
        setItems([]);
      } finally {
        setLoading(false);
      }
    }, 300); // 300 ms de debounce

    return () => clearTimeout(timeout);
  }, [query]);

  const products: Product[] = items.map(mapOfertaToProduct);

  return (
    <Card className="w-full">
      <CardHeader className="pb-3">
        <CardTitle>Seleccionar Producto (POSDPOFE)</CardTitle>
        <CardDescription>
          Busca ofertas por SKU o descripci√≥n de promoci√≥n
        </CardDescription>
      </CardHeader>

      <CardContent className="space-y-4">
        {/* Buscador */}

		<div className="flex items-center gap-2">
		  <ExcelUploader
			userName="Ronald Quiroga" // opcional: p√°salo desde contexto de login si tienes
			onUploaded={() => {
			  // opcional: puedes forzar un re-buscar con el t√©rmino actual
			  // setQuery(q => q ? q + ' ' : q); // hack m√≠nimo para disparar el useEffect
			}}
		  />
		</div>
		
        <div className="relative">
          {loading ? (
            <Loader2 className="absolute left-3 top-3 h-4 w-4 text-gray-400 animate-spin" />
          ) : (
            <Search className="absolute left-3 top-3 h-4 w-4 text-gray-400" />
          )}
          <Input
            placeholder="Buscar en POSDPOFE (SKU o descripci√≥n oferta)..."
            value={query}
            onChange={(e) => setQuery(e.target.value)}
            className="pl-10"
          />
        </div>

        {error && (
          <p className="text-xs text-red-600 bg-red-50 border border-red-200 rounded px-3 py-2">
            {error}
          </p>
        )}

        {/* Lista de resultados */}
        <div className="max-h-80 overflow-y-auto space-y-2">
          {loading && products.length === 0 ? (
            <div className="text-center py-6">
              <Loader2 className="h-5 w-5 animate-spin mx-auto mb-2 text-gray-400" />
              <p className="text-sm text-gray-500">
                Cargando ofertas desde POSDPOFE...
              </p>
            </div>
          ) : products.length > 0 ? (
            products.map((product) => (
              <Button
                key={product.id}
                variant={
                  selectedProduct?.id === product.id ? 'default' : 'outline'
                }
                className="w-full justify-start text-left h-auto py-3 px-4"
                onClick={() => onProductSelect(product)}
              >
                <div className="w-full">
                  <div className="font-semibold text-sm flex items-center gap-2">
                    {product.nombre}
                    {product.oferta && (
                      <span className="bg-red-500 text-white text-xs px-2 py-0.5 rounded">
                        -{product.oferta.descuentoPorcentaje}%
                      </span>
                    )}
                  </div>
                  <div className="text-xs text-gray-500 space-y-0.5">
                    <div className="flex gap-2 items-center">
                      {product.oferta ? (
                        <>
                          <span className="line-through text-gray-400">
                            $
                            {product.precioNormal.toLocaleString('es-CL')}
                          </span>
                          <span className="text-red-600 font-semibold">
                            ${product.precio.toLocaleString('es-CL')}
                          </span>
                        </>
                      ) : (
                        <span>
                          ${product.precio.toLocaleString('es-CL')}
                        </span>
                      )}
                    </div>
                    {product.oferta && product.oferta.vigenciaFin && (
                      <div>
                        Vigente hasta:{' '}
                        <span className="font-medium">
                          {product.oferta.vigenciaFin}
                        </span>
                      </div>
                    )}
                  </div>
                </div>
              </Button>
            ))
          ) : query.trim() ? (
            <div className="text-center py-6 text-sm text-gray-500">
              No se encontraron ofertas en POSDPOFE para ‚Äú{query}‚Äù.
            </div>
          ) : (
            <div className="text-xs text-gray-400">
              Escribe para buscar ofertas en POSDPOFE...
            </div>
          )}
        </div>

        {/* Resumen del producto seleccionado (puedes reutilizar el que ya ten√≠as) */}
        {selectedProduct && (
          <div className="border-t pt-4 mt-4 space-y-3">
            <h4 className="font-semibold text-sm mb-2">
              Producto Seleccionado
            </h4>
            <div className="bg-blue-50 p-3 rounded-lg space-y-2 text-sm">
              <p>
                <span className="font-semibold">SKU:</span>{' '}
                {selectedProduct.codigo}
              </p>
              <p>
                <span className="font-semibold">Nombre:</span>{' '}
                {selectedProduct.nombre}
              </p>
              <div className="border-t pt-2 mt-2 space-y-1">
                {selectedProduct.oferta ? (
                  <>
                    <p>
                      <span className="font-semibold">Precio Normal:</span>{' '}
                      <span className="line-through text-gray-500">
                        $
                        {selectedProduct.precioNormal.toLocaleString('es-CL')}
                      </span>
                    </p>
                    <p>
                      <span className="font-semibold text-red-600">
                        Precio Oferta:
                      </span>{' '}
                      <span className="text-red-600 font-bold">
                        $
                        {selectedProduct.precio.toLocaleString('es-CL')}
                      </span>
                    </p>
                    <p>
                      <span className="font-semibold">Descuento:</span>{' '}
                      {selectedProduct.oferta.descuentoPorcentaje}%
                    </p>
                    {selectedProduct.oferta.vigenciaFin && (
                      <p className="text-xs text-gray-600">
                        V√°lido hasta:{' '}
                        {selectedProduct.oferta.vigenciaFin}
                      </p>
                    )}
                  </>
                ) : (
                  <p>
                    <span className="font-semibold">Precio:</span>{' '}
                    $
                    {selectedProduct.precio.toLocaleString('es-CL')}
                  </p>
                )}
              </div>
            </div>
          </div>
        )}
      </CardContent>
    </Card>
  );
}
